<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Estoque e Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        body.dark-mode {
            background: #121212;
            color: #ffffff;
        }
footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 15px 0;
            margin-top: auto;
        }
        
        footer p {
            margin: 5px 0;
        }
        .dark-mode .card,
        .dark-mode .table,
        .dark-mode .form-control,
        .dark-mode .btn {
            background: #1e1e1e;
            color: #ffffff;
        }

        .theme-toggle {
            position: absolute;
            right: 15px;
            top: 10px;
        }

        @media (max-width: 768px) {
            .theme-toggle {
                top: 5px;
                right: 10px;
                font-size: 1.2rem;
            }

            .navbar-brand {
                font-size: 1rem;
            }
        }

        /* Melhoria da responsividade mobile */
        @media (max-width: 576px) {

            input,
            select,
            textarea,
            button {
                font-size: 0.9rem;
            }

            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tabs .nav-link {
                white-space: nowrap;
                font-size: 0.9rem;
                padding: 0.5rem;
            }

            .card-title {
                font-size: 1rem;
            }

            .btn {
                font-size: 0.9rem;
            }

            .theme-toggle {
                top: 5px;
                right: 10px;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark p-2">
        <span class="navbar-brand">üì¶ Controle de Estoque GIGASTRORE</span>
        <button class="btn btn-light theme-toggle" onclick="toggleTheme()">üåì</button>
    </nav>

    <div class="container-fluid mt-3 px-3 px-md-5">
        <ul class="nav nav-tabs mb-3" id="tabMenu">
            <li class="nav-item"><a class="nav-link active" onclick="showTab('produtos')">Produtos</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('estoque')">Estoque</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('ajustar')">Ajustar Estoque</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('vendas')">Vendas</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('relatorios')">Relat√≥rios</a></li>
        </ul>

        <!-- PRODUTOS -->
        <div id="produtos" class="tab-content">
            <h4>Cadastrar Produto</h4>
            <div class="row g-2">
                <div class="col-md-6"><input id="nome" class="form-control" placeholder="Nome do produto" /></div>
                <div class="col-md-6"><input id="codigo" class="form-control" placeholder="C√≥digo ou ID" /></div>
                <div class="col-md-4"><input id="preco" class="form-control" type="number" step="0.01"
                        placeholder="Pre√ßo" /></div>
                <div class="col-md-4"><input id="quantidade" class="form-control" type="number"
                        placeholder="Quantidade" /></div>
                <div class="col-md-4"><input id="estoqueMinimo" class="form-control" type="number"
                        placeholder="Estoque m√≠nimo" /></div>
                <div class="col-md-6"><select id="marca" class="form-control">
                        <option value="Avon">Avon</option>
                        <option value="Natura">Natura</option>
                        <option value="Eudora">Eudora</option>
                        <option value="O Botic√°rio">OBotic√°rio</option>
                        <option value="Demillus">Demillus</option>
                        <option value="Tupperware">Tupperware</option>
                    </select></div>
                <div class="col-md-12"><textarea id="obsProduto" class="form-control"
                        placeholder="Observa√ß√µes"></textarea></div>
                <div class="col-md-12"><button class="btn btn-primary w-100" onclick="adicionarProduto()">Salvar
                        Produto</button></div>
            </div>
        </div>

        <!-- ESTOQUE -->
        <div id="estoque" class="tab-content d-none">
            <h4>Estoque</h4>
            <input id="filtroBusca" class="form-control mb-2" placeholder="Buscar por nome ou c√≥digo"
                oninput="carregarProdutos()" />
            <select id="filtroMarca" class="form-control mb-3" onchange="carregarProdutos()">
                <option value="">Todas as marcas</option>
                <option>Avon</option>
                <option>Natura</option>
                <option>Eudora</option>
                <option>OBotic√°rio</option>
                <option>Demillus</option>
                <option>Tupperware</option>
            </select>
            <div class="row" id="tabelaEstoque"></div>
        </div>

        <!-- AJUSTAR -->
        <div id="ajustar" class="tab-content d-none">
            <h4>Ajustar Quantidade e Pre√ßo</h4>
            <div class="row g-2">
                <div class="col-md-12"><input id="ajusteBusca" class="form-control" placeholder="Buscar produto..."
                        oninput="buscarProdutoAjuste()" /></div>
                <div class="col-md-12"><select id="produtoAjuste" class="form-control"
                        onchange="preencherDadosProduto()"></select></div>
                <div class="col-md-6"><input id="quantidadeNova" class="form-control" type="number"
                        placeholder="Nova quantidade" /></div>
                <div class="col-md-6"><input id="precoNovo" class="form-control" type="number" step="0.01"
                        placeholder="Novo pre√ßo (opcional)" /></div>
                <div class="col-md-12"><button class="btn btn-primary w-100" onclick="ajustarEstoque()">Salvar
                        ajustes</button></div>
            </div>
        </div>

        <!-- VENDAS -->
        <div id="vendas" class="tab-content d-none">
            <h4>Registrar Venda</h4>
            <div class="row g-2">
                <div class="col-md-12"><input id="buscaVenda" class="form-control" placeholder="Buscar produto..."
                        oninput="buscarProdutoVenda()" /></div>
                <div class="col-md-12"><select id="produtoVenda" class="form-control"></select></div>
                <div class="col-md-6"><input id="quantidadeVenda" class="form-control" type="number" value="1"
                        placeholder="Quantidade" /></div>
                <div class="col-md-6"><input id="cliente" class="form-control" placeholder="Nome do cliente" /></div>
                <div class="col-md-6"><select id="formaPagamento" class="form-control">
                        <option value="PIX">PIX</option>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Cart√£o">Cart√£o</option>
                    </select></div>
                <div class="col-md-6"><input id="desconto" class="form-control"
                        placeholder="Desconto (ex: 10 ou 10%)" /></div>
                <div class="col-md-12"><textarea id="obsVenda" class="form-control"
                        placeholder="Observa√ß√µes"></textarea></div>
                <div class="col-md-12"><button class="btn btn-success w-100" onclick="registrarVenda()">Finalizar
                        Venda</button></div>
            </div>
        </div>

        <!-- RELAT√ìRIOS SIMPLIFICADO -->
        <div id="relatorios" class="tab-content d-none">
            <h4>Hist√≥rico de Vendas</h4>
            <div class="mb-3">
                <input type="date" id="dataInicio" class="form-control mb-2" onchange="carregarVendas()">
                <input type="date" id="dataFim" class="form-control" onchange="carregarVendas()">
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Valor</th>
                            <th>Cliente</th>
                            <th>Pagamento</th>
                        </tr>
                    </thead>
                    <tbody id="listaVendas">
                        <!-- As vendas ser√£o carregadas aqui -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <h5>Total: R$ <span id="totalVendas">0,00</span></h5>
                <button class="btn btn-danger w-100 mt-2" onclick="confirmarApagarVendas()">
                    üóëÔ∏è Apagar Todas as Vendas
                </button>
            </div>
        </div>
    </div>
 <footer>
        <p>&copy; 2025 GigaStore</p>
        <p>Todos os direitos reservados</p>
    </footer>
    <script>
        // Configura√ß√£o do Firebase - substitua com sua configura√ß√£o real
        const firebaseConfig = {
            apiKey: "AIzaSyAA4UWNsba88bnAfLmVC_50e30XaqI7T6I",
            authDomain: "controleestoque-be411.firebaseapp.com",
            projectId: "controleestoque-be411",
            storageBucket: "controleestoque-be411.appspot.com",
            messagingSenderId: "2805034353",
            appId: "1:2805034353:web:270e9c605939eb94da9ad0",
            measurementId: "G-DJSMT9V1QG"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('d-none'));
            document.getElementById(tabId).classList.remove('d-none');
            document.querySelectorAll('#tabMenu .nav-link').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tabId === 'relatorios') {
                carregarVendas();
            }
        }

        function adicionarProduto() {
            const produto = {
                nome: document.getElementById('nome').value.trim(),
                codigo: document.getElementById('codigo').value.trim(),
                preco: parseFloat(document.getElementById('preco').value),
                quantidade: parseInt(document.getElementById('quantidade').value),
                estoqueMinimo: parseInt(document.getElementById('estoqueMinimo').value) || 0,
                marca: document.getElementById('marca').value,
                obs: document.getElementById('obsProduto').value.trim()
            };

            if (!produto.nome || !produto.codigo || isNaN(produto.preco) || isNaN(produto.quantidade)) {
                return alert("Preencha os campos obrigat√≥rios corretamente.");
            }

            db.collection("produtos").doc(produto.codigo).set(produto)
                .then(() => {
                    alert("Produto salvo com sucesso!");
                    carregarProdutos();
                    limparCamposProduto();
                })
                .catch((error) => {
                    alert("Erro ao salvar produto: " + error.message);
                });
        }

        function limparCamposProduto() {
            document.getElementById('nome').value = "";
            document.getElementById('codigo').value = "";
            document.getElementById('preco').value = "";
            document.getElementById('quantidade').value = "";
            document.getElementById('estoqueMinimo').value = "";
            document.getElementById('marca').value = "Avon";
            document.getElementById('obsProduto').value = "";
        }

        async function carregarProdutos() {
            const busca = document.getElementById('filtroBusca').value.toLowerCase();
            const marcaFiltro = document.getElementById('filtroMarca').value;
            const container = document.getElementById("tabelaEstoque");
            const snapshot = await db.collection("produtos").get();
            container.innerHTML = "";

            snapshot.forEach(doc => {
                const p = doc.data();
                if ((p.nome.toLowerCase().includes(busca) || p.codigo.includes(busca)) && (!marcaFiltro || p.marca === marcaFiltro)) {
                    const alerta = p.quantidade <= p.estoqueMinimo ? '<span class="badge bg-danger">Baixo estoque</span>' : '';
                    container.innerHTML += `
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">${p.nome}</h5>
                                    <p class="card-text">Marca: ${p.marca}<br>Pre√ßo: R$ ${p.preco.toFixed(2)}<br>Qtd: ${p.quantidade} ${alerta}</p>
                                    <button class="btn btn-sm btn-warning" onclick="editarProduto('${p.nome}')">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarProduto('${p.nome}')">Excluir</button>
                                </div>
                            </div>
                        </div>`;
                }
            });
        }

        function buscarProdutoVenda() {
            const termo = document.getElementById('buscaVenda').value.toLowerCase();
            const select = document.getElementById("produtoVenda");
            db.collection("produtos").get().then(snapshot => {
                select.innerHTML = "";
                snapshot.forEach(doc => {
                    const p = doc.data();
                    if (p.nome.toLowerCase().includes(termo)) {
                        select.innerHTML += `<option value="${p.codigo}">${p.nome} (Qtd: ${p.quantidade})</option>`;
                    }
                });
            });
        }

        function buscarProdutoAjuste() {
            const termo = document.getElementById("ajusteBusca").value.toLowerCase();
            const select = document.getElementById("produtoAjuste");
            db.collection("produtos").get().then(snapshot => {
                select.innerHTML = "";
                snapshot.forEach(doc => {
                    const p = doc.data();
                    if (p.nome.toLowerCase().includes(termo)) {
                        select.innerHTML += `<option value="${p.codigo}">${p.nome} (Qtd atual: ${p.quantidade})</option>`;
                    }
                });
            });
        }

        function preencherDadosProduto() {
            const codigo = document.getElementById("produtoAjuste").value;
            if (!codigo) return;
            db.collection("produtos").doc(codigo).get().then(doc => {
                if (doc.exists) {
                    const p = doc.data();
                    document.getElementById("quantidadeNova").value = p.quantidade;
                    document.getElementById("precoNovo").value = p.preco;
                }
            });
        }

        function ajustarEstoque() {
            const codigo = document.getElementById("produtoAjuste").value;
            const novaQtd = parseInt(document.getElementById("quantidadeNova").value);
            const novoPreco = parseFloat(document.getElementById("precoNovo").value);

            if (!codigo || isNaN(novaQtd)) {
                return alert("Preencha corretamente os campos.");
            }

            const atualizacoes = { quantidade: novaQtd };

            if (!isNaN(novoPreco)) {
                atualizacoes.preco = novoPreco;
            }

            db.collection("produtos").doc(codigo).update(atualizacoes).then(() => {
                alert("Ajustes salvos com sucesso.");
                document.getElementById("quantidadeNova").value = "";
                document.getElementById("precoNovo").value = "";
                buscarProdutoAjuste();
                carregarProdutos();
            });
        }

        async function registrarVenda() {
            const codigo = document.getElementById("produtoVenda").value;
            const qtd = parseInt(document.getElementById("quantidadeVenda").value);
            const clienteNome = document.getElementById("cliente").value.trim();
            const forma = document.getElementById("formaPagamento").value;
            const descontoVal = document.getElementById("desconto").value.trim();
            const obs = document.getElementById("obsVenda").value.trim();

            if (!clienteNome || isNaN(qtd) || qtd <= 0) {
                return alert("Preencha os campos corretamente.");
            }

            const docRef = db.collection("produtos").doc(codigo);
            const doc = await docRef.get();
            const produto = doc.data();

            if (!produto || produto.quantidade < qtd) {
                return alert("Estoque insuficiente.");
            }

            let total = produto.preco * qtd;
            if (descontoVal.includes("%")) {
                const perc = parseFloat(descontoVal.replace("%", ""));
                if (!isNaN(perc)) total -= total * (perc / 100);
            } else if (!isNaN(parseFloat(descontoVal))) {
                total -= parseFloat(descontoVal);
            }

            await docRef.update({ quantidade: produto.quantidade - qtd });
            await db.collection("vendas").add({
                codigo: produto.codigo,
                nome: produto.nome,
                quantidade: qtd,
                total: total,
                cliente: clienteNome,
                forma: forma,
                obs: obs,
                data: new Date().toISOString()
            });

            alert("Venda registrada!");
            document.getElementById("quantidadeVenda").value = 1;
            document.getElementById("cliente").value = "";
            document.getElementById("desconto").value = "";
            document.getElementById("obsVenda").value = "";
            buscarProdutoVenda();
            carregarProdutos();
        }

        async function carregarVendas() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const listaVendas = document.getElementById('listaVendas');
            const totalVendas = document.getElementById('totalVendas');

            let query = db.collection("vendas").orderBy("data", "desc");

            if (dataInicio) {
                query = query.where("data", ">=", new Date(dataInicio).toISOString());
            }

            if (dataFim) {
                // Adiciona 1 dia para incluir o dia final
                const fim = new Date(dataFim);
                fim.setDate(fim.getDate() + 1);
                query = query.where("data", "<", fim.toISOString());
            }

            const snapshot = await query.get();
            listaVendas.innerHTML = '';
            let total = 0;

            if (snapshot.empty) {
                listaVendas.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma venda encontrada</td></tr>';
                totalVendas.textContent = '0,00';
                return;
            }

            snapshot.forEach(doc => {
                const v = doc.data();
                const data = new Date(v.data).toLocaleDateString('pt-BR');
                total += v.total;

                listaVendas.innerHTML += `
                    <tr>
                        <td>${data}</td>
                        <td>${v.nome}</td>
                        <td>${v.quantidade}</td>
                        <td>R$ ${v.total.toFixed(2)}</td>
                        <td>${v.cliente}</td>
                        <td>${v.forma}</td>
                    </tr>
                `;
            });

            totalVendas.textContent = total.toFixed(2);
        }

        let produtoEditando = null;

        function editarProduto(nomeProduto) {
            db.collection("produtos").where("nome", "==", nomeProduto).get().then(snapshot => {
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    produtoEditando = doc.id;
                    const p = doc.data();

                    document.getElementById('nome').value = p.nome;
                    document.getElementById('codigo').value = p.codigo;
                    document.getElementById('preco').value = p.preco;
                    document.getElementById('quantidade').value = p.quantidade;
                    document.getElementById('estoqueMinimo').value = p.estoqueMinimo || 0;
                    document.getElementById('marca').value = p.marca;
                    document.getElementById('obsProduto').value = p.obs || '';

                    showTab('produtos');

                    const btn = document.querySelector('#produtos button');
                    btn.textContent = 'Atualizar Produto';
                    btn.onclick = atualizarProduto;
                }
            });
        }

        function atualizarProduto() {
            if (!produtoEditando) return;

            const produto = {
                nome: document.getElementById('nome').value.trim(),
                codigo: document.getElementById('codigo').value.trim(),
                preco: parseFloat(document.getElementById('preco').value),
                quantidade: parseInt(document.getElementById('quantidade').value),
                estoqueMinimo: parseInt(document.getElementById('estoqueMinimo').value) || 0,
                marca: document.getElementById('marca').value,
                obs: document.getElementById('obsProduto').value.trim()
            };

            if (!produto.nome || !produto.codigo || isNaN(produto.preco)) {
                return alert("Preencha os campos obrigat√≥rios.");
            }

            db.collection("produtos").doc(produtoEditando).update(produto).then(() => {
                alert("Produto atualizado com sucesso!");
                produtoEditando = null;
                carregarProdutos();
                limparCamposProduto();

                const btn = document.querySelector('#produtos button');
                btn.textContent = 'Salvar Produto';
                btn.onclick = adicionarProduto;
            });
        }

        async function deletarProduto(nomeProduto) {
            const produtosSnapshot = await db.collection("produtos")
                .where("nome", "==", nomeProduto)
                .get();

            if (produtosSnapshot.empty) {
                return alert("Produto n√£o encontrado!");
            }

            const produtoDoc = produtosSnapshot.docs[0];
            const codigo = produtoDoc.id;
            const produtoData = produtoDoc.data();

            const vendasSnapshot = await db.collection("vendas")
                .where("codigo", "==", codigo)
                .get();

            if (!vendasSnapshot.empty) {
                const resposta = confirm(`O produto "${nomeProduto}" possui ${vendasSnapshot.size} venda(s) associada(s).\n\n` +
                    `Deseja desativ√°-lo em vez de excluir?\n\n` +
                    `‚úÖ Sim - para desativar\n` +
                    `‚ùå N√£o - para excluir mesmo assim`);

                if (resposta) {
                    await db.collection("produtos").doc(codigo).update({
                        ativo: false,
                        dataDesativacao: new Date().toISOString()
                    });
                    alert(`"${nomeProduto}" foi desativado com sucesso!`);
                } else {
                    if (confirm(`‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel!\n\n` +
                        `Tem certeza que deseja excluir permanentemente "${nomeProduto}"?\n` +
                        `Isso afetar√° ${vendasSnapshot.size} registro(s) de venda.`)) {
                        await db.collection("produtos").doc(codigo).delete();
                        alert(`"${nomeProduto}" foi exclu√≠do permanentemente`);
                    } else {
                        return;
                    }
                }
            } else {
                if (confirm(`Deseja excluir o produto "${nomeProduto}"?`)) {
                    await db.collection("produtos").doc(codigo).delete();
                    alert(`"${nomeProduto}" foi exclu√≠do com sucesso`);
                } else {
                    return;
                }
            }

            carregarProdutos();
        }
        async function confirmarApagarVendas() {
            const confirmacao = confirm("‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODOS os registros de vendas permanentemente!\n\nTem certeza que deseja continuar?");

            if (confirmacao) {
                await apagarTodasVendas();
            }
        }

        async function apagarTodasVendas() {
            try {
                // Primeiro obtemos todas as vendas
                const snapshot = await db.collection("vendas").get();

                // Criamos um batch (lote) para deletar tudo de uma vez
                const batch = db.batch();

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                alert("Todas as vendas foram apagadas com sucesso!");
                carregarVendas(); // Atualiza a lista
            } catch (error) {
                console.error("Erro ao apagar vendas:", error);
                alert("Ocorreu um erro ao apagar as vendas: " + error.message);
            }
        }
        // Inicializa√ß√µes
        document.addEventListener('DOMContentLoaded', function () {
            // Configurar datas padr√£o (√∫ltimos 30 dias)
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);

            document.getElementById('dataFim').valueAsDate = hoje;
            document.getElementById('dataInicio').valueAsDate = trintaDiasAtras;

            carregarProdutos();
            buscarProdutoVenda();
            buscarProdutoAjuste();
        });

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            alert("Erro ao conectar com o banco de dados. Recarregue a p√°gina.");
        }
    </script>
</body>

</html>